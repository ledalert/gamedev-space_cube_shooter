#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <GLFW/glfw3.h>
#include <pthread.h>
#include "SOIL/SOIL.h"



//This is slowing down the application so that I may record it without dropping too many
//frames on my slow computer
//#define glfwGetTime() (glfwGetTime()/10)



struct cube {
	float x;
	float y;
	float z;
	float r;
	float g;
	float b;
};

struct cube ship[558] = {{9,6,0,0.627451,0.917647,0.894118},{9,6,1,0.627451,0.917647,0.894118},{9,6,2,0.627451,0.917647,0.894118},{9,7,2,0.086275,0.270588,0.447059},{9,6,3,0.627451,0.917647,0.894118},{9,7,3,0.627451,0.917647,0.894118},{9,5,4,0.086275,0.270588,0.447059},{9,6,4,0.627451,0.917647,0.894118},{9,7,4,0.627451,0.917647,0.894118},{9,5,5,0.658824,0.254902,0.066667},{9,6,5,0.627451,0.917647,0.894118},{8,7,5,0.086275,0.270588,0.447059},{9,7,5,0.086275,0.270588,0.447059},{10,7,5,0.086275,0.270588,0.447059},{8,8,5,0.086275,0.270588,0.447059},{9,8,5,0.086275,0.270588,0.447059},{10,8,5,0.086275,0.270588,0.447059},{8,5,6,0.658824,0.254902,0.066667},{9,5,6,0.658824,0.254902,0.066667},{10,5,6,0.658824,0.254902,0.066667},{9,6,6,0.627451,0.917647,0.894118},{8,7,6,0.086275,0.270588,0.447059},{9,7,6,0.086275,0.270588,0.447059},{10,7,6,0.086275,0.270588,0.447059},{6,8,6,0.086275,0.270588,0.447059},{7,8,6,0.086275,0.270588,0.447059},{8,8,6,0.086275,0.270588,0.447059},{9,8,6,0.086275,0.270588,0.447059},{10,8,6,0.086275,0.270588,0.447059},{11,8,6,0.086275,0.270588,0.447059},{12,8,6,0.086275,0.270588,0.447059},{9,4,7,0.658824,0.254902,0.066667},{8,5,7,0.658824,0.254902,0.066667},{9,5,7,0.658824,0.254902,0.066667},{10,5,7,0.658824,0.254902,0.066667},{9,6,7,0.627451,0.917647,0.894118},{7,7,7,0.086275,0.270588,0.447059},{8,7,7,0.086275,0.270588,0.447059},{9,7,7,0.086275,0.270588,0.447059},{10,7,7,0.086275,0.270588,0.447059},{11,7,7,0.086275,0.270588,0.447059},{5,8,7,0.627451,0.917647,0.894118},{6,8,7,0.627451,0.917647,0.894118},{7,8,7,0.086275,0.270588,0.447059},{8,8,7,0.086275,0.270588,0.447059},{9,8,7,0.086275,0.270588,0.447059},{10,8,7,0.086275,0.270588,0.447059},{11,8,7,0.086275,0.270588,0.447059},{12,8,7,0.627451,0.917647,0.894118},{13,8,7,0.627451,0.917647,0.894118},{9,4,8,0.658824,0.254902,0.066667},{8,5,8,0.658824,0.254902,0.066667},{9,5,8,0.658824,0.254902,0.066667},{10,5,8,0.658824,0.254902,0.066667},{8,6,8,0.627451,0.917647,0.894118},{9,6,8,0.627451,0.917647,0.894118},{10,6,8,0.627451,0.917647,0.894118},{7,7,8,0.086275,0.270588,0.447059},{8,7,8,0.086275,0.270588,0.447059},{9,7,8,0.086275,0.270588,0.447059},{10,7,8,0.086275,0.270588,0.447059},{11,7,8,0.086275,0.270588,0.447059},{5,8,8,0.627451,0.917647,0.894118},{6,8,8,0.086275,0.270588,0.447059},{7,8,8,0.086275,0.270588,0.447059},{8,8,8,0.086275,0.270588,0.447059},{9,8,8,0.086275,0.270588,0.447059},{10,8,8,0.086275,0.270588,0.447059},{11,8,8,0.086275,0.270588,0.447059},{12,8,8,0.086275,0.270588,0.447059},{13,8,8,0.627451,0.917647,0.894118},{5,9,8,0.086275,0.270588,0.447059},{6,9,8,0.086275,0.270588,0.447059},{7,9,8,0.086275,0.270588,0.447059},{8,9,8,0.086275,0.270588,0.447059},{10,9,8,0.086275,0.270588,0.447059},{11,9,8,0.086275,0.270588,0.447059},{12,9,8,0.086275,0.270588,0.447059},{13,9,8,0.086275,0.270588,0.447059},{9,4,9,0.658824,0.254902,0.066667},{8,5,9,0.627451,0.917647,0.894118},{9,5,9,0.054902,0.094118,0.003922},{10,5,9,0.627451,0.917647,0.894118},{8,6,9,0.627451,0.917647,0.894118},{9,6,9,0.627451,0.917647,0.894118},{10,6,9,0.627451,0.917647,0.894118},{6,7,9,0.086275,0.270588,0.447059},{7,7,9,0.627451,0.917647,0.894118},{8,7,9,0.086275,0.270588,0.447059},{9,7,9,0.086275,0.270588,0.447059},{10,7,9,0.086275,0.270588,0.447059},{11,7,9,0.627451,0.917647,0.894118},{12,7,9,0.086275,0.270588,0.447059},{5,8,9,0.627451,0.917647,0.894118},{6,8,9,0.086275,0.270588,0.447059},{7,8,9,0.086275,0.270588,0.447059},{8,8,9,0.086275,0.270588,0.447059},{9,8,9,0.086275,0.270588,0.447059},{10,8,9,0.086275,0.270588,0.447059},{11,8,9,0.086275,0.270588,0.447059},{12,8,9,0.086275,0.270588,0.447059},{13,8,9,0.627451,0.917647,0.894118},{4,9,9,0.086275,0.270588,0.447059},{5,9,9,0.086275,0.270588,0.447059},{6,9,9,0.086275,0.270588,0.447059},{7,9,9,0.086275,0.270588,0.447059},{8,9,9,0.086275,0.270588,0.447059},{10,9,9,0.086275,0.270588,0.447059},{11,9,9,0.086275,0.270588,0.447059},{12,9,9,0.086275,0.270588,0.447059},{13,9,9,0.086275,0.270588,0.447059},{14,9,9,0.086275,0.270588,0.447059},{9,4,10,0.054902,0.094118,0.003922},{8,5,10,0.627451,0.917647,0.894118},{9,5,10,0.086275,0.270588,0.447059},{10,5,10,0.627451,0.917647,0.894118},{7,6,10,0.627451,0.917647,0.894118},{8,6,10,0.627451,0.917647,0.894118},{9,6,10,0.627451,0.917647,0.894118},{10,6,10,0.627451,0.917647,0.894118},{11,6,10,0.627451,0.917647,0.894118},{6,7,10,0.086275,0.270588,0.447059},{7,7,10,0.627451,0.917647,0.894118},{8,7,10,0.086275,0.270588,0.447059},{9,7,10,0.086275,0.270588,0.447059},{10,7,10,0.086275,0.270588,0.447059},{11,7,10,0.627451,0.917647,0.894118},{12,7,10,0.086275,0.270588,0.447059},{5,8,10,0.627451,0.917647,0.894118},{6,8,10,0.086275,0.270588,0.447059},{7,8,10,0.086275,0.270588,0.447059},{8,8,10,0.086275,0.270588,0.447059},{9,8,10,0.086275,0.270588,0.447059},{10,8,10,0.086275,0.270588,0.447059},{11,8,10,0.086275,0.270588,0.447059},{12,8,10,0.086275,0.270588,0.447059},{13,8,10,0.627451,0.917647,0.894118},{4,9,10,0.086275,0.270588,0.447059},{5,9,10,0.086275,0.270588,0.447059},{6,9,10,0.086275,0.270588,0.447059},{7,9,10,0.086275,0.270588,0.447059},{8,9,10,0.086275,0.270588,0.447059},{10,9,10,0.086275,0.270588,0.447059},{11,9,10,0.086275,0.270588,0.447059},{12,9,10,0.086275,0.270588,0.447059},{13,9,10,0.086275,0.270588,0.447059},{14,9,10,0.086275,0.270588,0.447059},{4,10,10,0.086275,0.270588,0.447059},{14,10,10,0.086275,0.270588,0.447059},{9,4,11,0.086275,0.270588,0.447059},{8,5,11,0.627451,0.917647,0.894118},{9,5,11,0.627451,0.917647,0.894118},{10,5,11,0.627451,0.917647,0.894118},{7,6,11,0.627451,0.917647,0.894118},{8,6,11,0.627451,0.917647,0.894118},{9,6,11,0.627451,0.917647,0.894118},{10,6,11,0.627451,0.917647,0.894118},{11,6,11,0.627451,0.917647,0.894118},{6,7,11,0.086275,0.270588,0.447059},{7,7,11,0.627451,0.917647,0.894118},{8,7,11,0.086275,0.270588,0.447059},{9,7,11,0.086275,0.270588,0.447059},{10,7,11,0.086275,0.270588,0.447059},{11,7,11,0.627451,0.917647,0.894118},{12,7,11,0.086275,0.270588,0.447059},{5,8,11,0.627451,0.917647,0.894118},{6,8,11,0.086275,0.270588,0.447059},{7,8,11,0.086275,0.270588,0.447059},{8,8,11,0.086275,0.270588,0.447059},{9,8,11,0.086275,0.270588,0.447059},{10,8,11,0.086275,0.270588,0.447059},{11,8,11,0.086275,0.270588,0.447059},{12,8,11,0.086275,0.270588,0.447059},{13,8,11,0.627451,0.917647,0.894118},{4,9,11,0.086275,0.270588,0.447059},{5,9,11,0.086275,0.270588,0.447059},{6,9,11,0.086275,0.270588,0.447059},{7,9,11,0.086275,0.270588,0.447059},{8,9,11,0.086275,0.270588,0.447059},{10,9,11,0.086275,0.270588,0.447059},{11,9,11,0.086275,0.270588,0.447059},{12,9,11,0.086275,0.270588,0.447059},{13,9,11,0.086275,0.270588,0.447059},{14,9,11,0.086275,0.270588,0.447059},{3,10,11,0.086275,0.270588,0.447059},{4,10,11,0.086275,0.270588,0.447059},{14,10,11,0.086275,0.270588,0.447059},{15,10,11,0.086275,0.270588,0.447059},{9,3,12,0.086275,0.270588,0.447059},{9,4,12,0.054902,0.094118,0.003922},{8,5,12,0.627451,0.917647,0.894118},{9,5,12,0.627451,0.917647,0.894118},{10,5,12,0.627451,0.917647,0.894118},{7,6,12,0.627451,0.917647,0.894118},{8,6,12,0.627451,0.917647,0.894118},{9,6,12,0.627451,0.917647,0.894118},{10,6,12,0.627451,0.917647,0.894118},{11,6,12,0.627451,0.917647,0.894118},{6,7,12,0.086275,0.270588,0.447059},{7,7,12,0.627451,0.917647,0.894118},{8,7,12,0.086275,0.270588,0.447059},{9,7,12,0.086275,0.270588,0.447059},{10,7,12,0.086275,0.270588,0.447059},{11,7,12,0.627451,0.917647,0.894118},{12,7,12,0.086275,0.270588,0.447059},{5,8,12,0.627451,0.917647,0.894118},{6,8,12,0.086275,0.270588,0.447059},{7,8,12,0.086275,0.270588,0.447059},{8,8,12,0.086275,0.270588,0.447059},{9,8,12,0.086275,0.270588,0.447059},{10,8,12,0.086275,0.270588,0.447059},{11,8,12,0.086275,0.270588,0.447059},{12,8,12,0.086275,0.270588,0.447059},{13,8,12,0.627451,0.917647,0.894118},{3,9,12,0.627451,0.917647,0.894118},{4,9,12,0.086275,0.270588,0.447059},{5,9,12,0.086275,0.270588,0.447059},{6,9,12,0.086275,0.270588,0.447059},{7,9,12,0.086275,0.270588,0.447059},{8,9,12,0.086275,0.270588,0.447059},{10,9,12,0.086275,0.270588,0.447059},{11,9,12,0.086275,0.270588,0.447059},{12,9,12,0.086275,0.270588,0.447059},{13,9,12,0.086275,0.270588,0.447059},{14,9,12,0.086275,0.270588,0.447059},{15,9,12,0.627451,0.917647,0.894118},{3,10,12,0.086275,0.270588,0.447059},{4,10,12,0.086275,0.270588,0.447059},{14,10,12,0.086275,0.270588,0.447059},{15,10,12,0.086275,0.270588,0.447059},{9,3,13,0.086275,0.270588,0.447059},{9,4,13,0.054902,0.094118,0.003922},{8,5,13,0.627451,0.917647,0.894118},{9,5,13,0.627451,0.917647,0.894118},{10,5,13,0.627451,0.917647,0.894118},{7,6,13,0.627451,0.917647,0.894118},{8,6,13,0.627451,0.917647,0.894118},{9,6,13,0.627451,0.917647,0.894118},{10,6,13,0.627451,0.917647,0.894118},{11,6,13,0.627451,0.917647,0.894118},{6,7,13,0.086275,0.270588,0.447059},{7,7,13,0.627451,0.917647,0.894118},{8,7,13,0.086275,0.270588,0.447059},{9,7,13,0.086275,0.270588,0.447059},{10,7,13,0.086275,0.270588,0.447059},{11,7,13,0.627451,0.917647,0.894118},{12,7,13,0.086275,0.270588,0.447059},{4,8,13,0.627451,0.917647,0.894118},{5,8,13,0.627451,0.917647,0.894118},{6,8,13,0.086275,0.270588,0.447059},{7,8,13,0.086275,0.270588,0.447059},{8,8,13,0.086275,0.270588,0.447059},{9,8,13,0.086275,0.270588,0.447059},{10,8,13,0.086275,0.270588,0.447059},{11,8,13,0.086275,0.270588,0.447059},{12,8,13,0.086275,0.270588,0.447059},{13,8,13,0.627451,0.917647,0.894118},{14,8,13,0.627451,0.917647,0.894118},{3,9,13,0.627451,0.917647,0.894118},{4,9,13,0.086275,0.270588,0.447059},{5,9,13,0.086275,0.270588,0.447059},{6,9,13,0.086275,0.270588,0.447059},{7,9,13,0.086275,0.270588,0.447059},{8,9,13,0.086275,0.270588,0.447059},{10,9,13,0.086275,0.270588,0.447059},{11,9,13,0.086275,0.270588,0.447059},{12,9,13,0.086275,0.270588,0.447059},{13,9,13,0.086275,0.270588,0.447059},{14,9,13,0.086275,0.270588,0.447059},{15,9,13,0.627451,0.917647,0.894118},{2,10,13,0.086275,0.270588,0.447059},{3,10,13,0.086275,0.270588,0.447059},{4,10,13,0.086275,0.270588,0.447059},{14,10,13,0.086275,0.270588,0.447059},{15,10,13,0.086275,0.270588,0.447059},{16,10,13,0.086275,0.270588,0.447059},{9,2,14,0.086275,0.270588,0.447059},{9,3,14,0.627451,0.917647,0.894118},{9,4,14,0.054902,0.094118,0.003922},{8,5,14,0.627451,0.917647,0.894118},{9,5,14,0.627451,0.917647,0.894118},{10,5,14,0.627451,0.917647,0.894118},{7,6,14,0.627451,0.917647,0.894118},{8,6,14,0.627451,0.917647,0.894118},{9,6,14,0.627451,0.917647,0.894118},{10,6,14,0.627451,0.917647,0.894118},{11,6,14,0.627451,0.917647,0.894118},{5,7,14,0.086275,0.270588,0.447059},{6,7,14,0.627451,0.917647,0.894118},{7,7,14,0.627451,0.917647,0.894118},{8,7,14,0.086275,0.270588,0.447059},{9,7,14,0.086275,0.270588,0.447059},{10,7,14,0.086275,0.270588,0.447059},{11,7,14,0.627451,0.917647,0.894118},{12,7,14,0.627451,0.917647,0.894118},{13,7,14,0.086275,0.270588,0.447059},{4,8,14,0.627451,0.917647,0.894118},{5,8,14,0.086275,0.270588,0.447059},{6,8,14,0.086275,0.270588,0.447059},{7,8,14,0.086275,0.270588,0.447059},{8,8,14,0.086275,0.270588,0.447059},{9,8,14,0.086275,0.270588,0.447059},{10,8,14,0.086275,0.270588,0.447059},{11,8,14,0.086275,0.270588,0.447059},{12,8,14,0.086275,0.270588,0.447059},{13,8,14,0.086275,0.270588,0.447059},{14,8,14,0.627451,0.917647,0.894118},{3,9,14,0.627451,0.917647,0.894118},{4,9,14,0.086275,0.270588,0.447059},{5,9,14,0.086275,0.270588,0.447059},{6,9,14,0.086275,0.270588,0.447059},{7,9,14,0.086275,0.270588,0.447059},{8,9,14,0.086275,0.270588,0.447059},{10,9,14,0.086275,0.270588,0.447059},{11,9,14,0.086275,0.270588,0.447059},{12,9,14,0.086275,0.270588,0.447059},{13,9,14,0.086275,0.270588,0.447059},{14,9,14,0.086275,0.270588,0.447059},{15,9,14,0.627451,0.917647,0.894118},{1,10,14,0.086275,0.270588,0.447059},{2,10,14,0.086275,0.270588,0.447059},{3,10,14,0.086275,0.270588,0.447059},{4,10,14,0.086275,0.270588,0.447059},{14,10,14,0.086275,0.270588,0.447059},{15,10,14,0.086275,0.270588,0.447059},{16,10,14,0.086275,0.270588,0.447059},{17,10,14,0.086275,0.270588,0.447059},{9,2,15,0.086275,0.270588,0.447059},{9,3,15,0.627451,0.917647,0.894118},{9,4,15,0.054902,0.094118,0.003922},{7,5,15,0.627451,0.917647,0.894118},{8,5,15,0.627451,0.917647,0.894118},{9,5,15,0.627451,0.917647,0.894118},{10,5,15,0.627451,0.917647,0.894118},{11,5,15,0.627451,0.917647,0.894118},{6,6,15,0.627451,0.917647,0.894118},{7,6,15,0.627451,0.917647,0.894118},{8,6,15,0.627451,0.917647,0.894118},{9,6,15,0.627451,0.917647,0.894118},{10,6,15,0.627451,0.917647,0.894118},{11,6,15,0.627451,0.917647,0.894118},{12,6,15,0.627451,0.917647,0.894118},{5,7,15,0.086275,0.270588,0.447059},{6,7,15,0.627451,0.917647,0.894118},{7,7,15,0.627451,0.917647,0.894118},{8,7,15,0.086275,0.270588,0.447059},{9,7,15,0.086275,0.270588,0.447059},{10,7,15,0.086275,0.270588,0.447059},{11,7,15,0.627451,0.917647,0.894118},{12,7,15,0.627451,0.917647,0.894118},{13,7,15,0.086275,0.270588,0.447059},{3,8,15,0.627451,0.917647,0.894118},{4,8,15,0.627451,0.917647,0.894118},{5,8,15,0.086275,0.270588,0.447059},{6,8,15,0.086275,0.270588,0.447059},{7,8,15,0.086275,0.270588,0.447059},{8,8,15,0.086275,0.270588,0.447059},{9,8,15,0.086275,0.270588,0.447059},{10,8,15,0.086275,0.270588,0.447059},{11,8,15,0.086275,0.270588,0.447059},{12,8,15,0.086275,0.270588,0.447059},{13,8,15,0.086275,0.270588,0.447059},{14,8,15,0.627451,0.917647,0.894118},{15,8,15,0.627451,0.917647,0.894118},{2,9,15,0.627451,0.917647,0.894118},{3,9,15,0.086275,0.270588,0.447059},{4,9,15,0.086275,0.270588,0.447059},{5,9,15,0.086275,0.270588,0.447059},{6,9,15,0.086275,0.270588,0.447059},{7,9,15,0.086275,0.270588,0.447059},{8,9,15,0.086275,0.270588,0.447059},{10,9,15,0.086275,0.270588,0.447059},{11,9,15,0.086275,0.270588,0.447059},{12,9,15,0.086275,0.270588,0.447059},{13,9,15,0.086275,0.270588,0.447059},{14,9,15,0.086275,0.270588,0.447059},{15,9,15,0.086275,0.270588,0.447059},{16,9,15,0.627451,0.917647,0.894118},{0,10,15,0.086275,0.270588,0.447059},{1,10,15,0.086275,0.270588,0.447059},{2,10,15,0.086275,0.270588,0.447059},{3,10,15,0.086275,0.270588,0.447059},{4,10,15,0.086275,0.270588,0.447059},{14,10,15,0.086275,0.270588,0.447059},{15,10,15,0.086275,0.270588,0.447059},{16,10,15,0.086275,0.270588,0.447059},{17,10,15,0.086275,0.270588,0.447059},{18,10,15,0.086275,0.270588,0.447059},{9,1,16,0.086275,0.270588,0.447059},{9,2,16,0.627451,0.917647,0.894118},{9,3,16,0.627451,0.917647,0.894118},{9,4,16,0.054902,0.094118,0.003922},{7,5,16,0.627451,0.917647,0.894118},{8,5,16,0.627451,0.917647,0.894118},{9,5,16,0.627451,0.917647,0.894118},{10,5,16,0.627451,0.917647,0.894118},{11,5,16,0.627451,0.917647,0.894118},{6,6,16,0.627451,0.917647,0.894118},{7,6,16,0.627451,0.917647,0.894118},{8,6,16,0.627451,0.917647,0.894118},{9,6,16,0.627451,0.917647,0.894118},{10,6,16,0.627451,0.917647,0.894118},{11,6,16,0.627451,0.917647,0.894118},{12,6,16,0.627451,0.917647,0.894118},{4,7,16,0.086275,0.270588,0.447059},{5,7,16,0.627451,0.917647,0.894118},{6,7,16,0.627451,0.917647,0.894118},{7,7,16,0.627451,0.917647,0.894118},{8,7,16,0.086275,0.270588,0.447059},{9,7,16,0.086275,0.270588,0.447059},{10,7,16,0.086275,0.270588,0.447059},{11,7,16,0.627451,0.917647,0.894118},{12,7,16,0.627451,0.917647,0.894118},{13,7,16,0.627451,0.917647,0.894118},{14,7,16,0.086275,0.270588,0.447059},{3,8,16,0.627451,0.917647,0.894118},{4,8,16,0.086275,0.270588,0.447059},{5,8,16,0.086275,0.270588,0.447059},{6,8,16,0.086275,0.270588,0.447059},{7,8,16,0.627451,0.917647,0.894118},{8,8,16,0.086275,0.270588,0.447059},{9,8,16,0.086275,0.270588,0.447059},{10,8,16,0.086275,0.270588,0.447059},{11,8,16,0.627451,0.917647,0.894118},{12,8,16,0.086275,0.270588,0.447059},{13,8,16,0.086275,0.270588,0.447059},{14,8,16,0.086275,0.270588,0.447059},{15,8,16,0.627451,0.917647,0.894118},{1,9,16,0.627451,0.917647,0.894118},{2,9,16,0.627451,0.917647,0.894118},{3,9,16,0.086275,0.270588,0.447059},{4,9,16,0.086275,0.270588,0.447059},{5,9,16,0.086275,0.270588,0.447059},{6,9,16,0.627451,0.917647,0.894118},{7,9,16,0.627451,0.917647,0.894118},{8,9,16,0.086275,0.270588,0.447059},{10,9,16,0.086275,0.270588,0.447059},{11,9,16,0.627451,0.917647,0.894118},{12,9,16,0.627451,0.917647,0.894118},{13,9,16,0.086275,0.270588,0.447059},{14,9,16,0.086275,0.270588,0.447059},{15,9,16,0.086275,0.270588,0.447059},{16,9,16,0.627451,0.917647,0.894118},{17,9,16,0.627451,0.917647,0.894118},{0,10,16,0.086275,0.270588,0.447059},{1,10,16,0.086275,0.270588,0.447059},{2,10,16,0.086275,0.270588,0.447059},{3,10,16,0.086275,0.270588,0.447059},{4,10,16,0.086275,0.270588,0.447059},{14,10,16,0.086275,0.270588,0.447059},{15,10,16,0.086275,0.270588,0.447059},{16,10,16,0.086275,0.270588,0.447059},{17,10,16,0.086275,0.270588,0.447059},{18,10,16,0.086275,0.270588,0.447059},{9,1,17,0.086275,0.270588,0.447059},{9,2,17,0.627451,0.917647,0.894118},{9,3,17,0.627451,0.917647,0.894118},{9,4,17,0.054902,0.094118,0.003922},{7,5,17,0.627451,0.917647,0.894118},{8,5,17,0.627451,0.917647,0.894118},{9,5,17,0.627451,0.917647,0.894118},{10,5,17,0.627451,0.917647,0.894118},{11,5,17,0.627451,0.917647,0.894118},{6,6,17,0.627451,0.917647,0.894118},{7,6,17,0.627451,0.917647,0.894118},{8,6,17,0.627451,0.917647,0.894118},{9,6,17,0.627451,0.917647,0.894118},{10,6,17,0.627451,0.917647,0.894118},{11,6,17,0.627451,0.917647,0.894118},{12,6,17,0.627451,0.917647,0.894118},{4,7,17,0.086275,0.270588,0.447059},{5,7,17,0.086275,0.270588,0.447059},{6,7,17,0.086275,0.270588,0.447059},{7,7,17,0.086275,0.270588,0.447059},{8,7,17,0.086275,0.270588,0.447059},{9,7,17,0.086275,0.270588,0.447059},{10,7,17,0.086275,0.270588,0.447059},{11,7,17,0.086275,0.270588,0.447059},{12,7,17,0.086275,0.270588,0.447059},{13,7,17,0.086275,0.270588,0.447059},{14,7,17,0.086275,0.270588,0.447059},{3,8,17,0.086275,0.270588,0.447059},{4,8,17,0.086275,0.270588,0.447059},{5,8,17,0.086275,0.270588,0.447059},{6,8,17,0.086275,0.270588,0.447059},{7,8,17,0.627451,0.917647,0.894118},{8,8,17,0.086275,0.270588,0.447059},{9,8,17,0.086275,0.270588,0.447059},{10,8,17,0.086275,0.270588,0.447059},{11,8,17,0.627451,0.917647,0.894118},{12,8,17,0.086275,0.270588,0.447059},{13,8,17,0.086275,0.270588,0.447059},{14,8,17,0.086275,0.270588,0.447059},{15,8,17,0.086275,0.270588,0.447059},{1,9,17,0.627451,0.917647,0.894118},{2,9,17,0.627451,0.917647,0.894118},{3,9,17,0.086275,0.270588,0.447059},{4,9,17,0.086275,0.270588,0.447059},{5,9,17,0.086275,0.270588,0.447059},{6,9,17,0.627451,0.917647,0.894118},{7,9,17,0.627451,0.917647,0.894118},{8,9,17,0.086275,0.270588,0.447059},{10,9,17,0.086275,0.270588,0.447059},{11,9,17,0.627451,0.917647,0.894118},{12,9,17,0.627451,0.917647,0.894118},{13,9,17,0.086275,0.270588,0.447059},{14,9,17,0.086275,0.270588,0.447059},{15,9,17,0.086275,0.270588,0.447059},{16,9,17,0.627451,0.917647,0.894118},{17,9,17,0.627451,0.917647,0.894118},{0,10,17,0.086275,0.270588,0.447059},{1,10,17,0.086275,0.270588,0.447059},{2,10,17,0.086275,0.270588,0.447059},{3,10,17,0.086275,0.270588,0.447059},{4,10,17,0.086275,0.270588,0.447059},{14,10,17,0.086275,0.270588,0.447059},{15,10,17,0.086275,0.270588,0.447059},{16,10,17,0.086275,0.270588,0.447059},{17,10,17,0.086275,0.270588,0.447059},{18,10,17,0.086275,0.270588,0.447059},{9,0,18,0.086275,0.270588,0.447059},{9,1,18,0.627451,0.917647,0.894118},{9,2,18,0.627451,0.917647,0.894118},{9,3,18,0.086275,0.270588,0.447059},{8,5,18,0.054902,0.094118,0.003922},{9,5,18,0.054902,0.094118,0.003922},{10,5,18,0.054902,0.094118,0.003922},{8,6,18,0.054902,0.094118,0.003922},{9,6,18,0.054902,0.094118,0.003922},{10,6,18,0.054902,0.094118,0.003922},{8,7,18,0.054902,0.094118,0.003922},{9,7,18,0.054902,0.094118,0.003922},{10,7,18,0.054902,0.094118,0.003922},{9,0,19,0.086275,0.270588,0.447059},{9,1,19,0.627451,0.917647,0.894118},{9,2,19,0.086275,0.270588,0.447059},{8,5,19,0.627451,0.917647,0.894118},{9,5,19,0.627451,0.917647,0.894118},{10,5,19,0.627451,0.917647,0.894118},{8,6,19,0.627451,0.917647,0.894118},{9,6,19,0.627451,0.917647,0.894118},{10,6,19,0.627451,0.917647,0.894118},{8,7,19,0.627451,0.917647,0.894118},{9,7,19,0.627451,0.917647,0.894118},{10,7,19,0.627451,0.917647,0.894118},{9,0,20,0.627451,0.917647,0.894118},{9,1,20,0.086275,0.270588,0.447059},{9,6,20,0.054902,0.094118,0.003922},{9,0,21,0.086275,0.270588,0.447059},{9,6,21,0.627451,0.917647,0.894118},{9,5,22,0.588235,0.047059,0.086275},{9,6,22,0.929412,0.713725,0.223529},{9,7,22,0.588235,0.047059,0.086275},{9,5,23,0.588235,0.047059,0.086275},{9,6,23,0.929412,0.713725,0.223529},{9,7,23,0.588235,0.047059,0.086275},{9,6,24,0.588235,0.047059,0.086275},{9,6,25,0.588235,0.047059,0.086275}};
struct cube toaster[141] = {{2,6,0,0.627451,0.917647,0.894118},{1,4,1,0.627451,0.917647,0.894118},{2,4,1,0.627451,0.917647,0.894118},{3,4,1,0.627451,0.917647,0.894118},{1,5,1,0.627451,0.917647,0.894118},{2,5,1,0.627451,0.917647,0.894118},{3,5,1,0.627451,0.917647,0.894118},{1,6,1,0.627451,0.917647,0.894118},{2,6,1,0.627451,0.917647,0.894118},{3,6,1,0.627451,0.917647,0.894118},{1,7,1,0.627451,0.917647,0.894118},{2,7,1,0.627451,0.917647,0.894118},{3,7,1,0.627451,0.917647,0.894118},{0,4,2,0.627451,0.917647,0.894118},{1,4,2,0.627451,0.917647,0.894118},{2,4,2,0.627451,0.917647,0.894118},{3,4,2,0.627451,0.917647,0.894118},{4,4,2,0.627451,0.917647,0.894118},{0,5,2,0.627451,0.917647,0.894118},{1,5,2,0.627451,0.917647,0.894118},{2,5,2,0.627451,0.917647,0.894118},{3,5,2,0.627451,0.917647,0.894118},{4,5,2,0.627451,0.917647,0.894118},{0,6,2,0.627451,0.917647,0.894118},{1,6,2,0.627451,0.917647,0.894118},{2,6,2,0.627451,0.917647,0.894118},{3,6,2,0.627451,0.917647,0.894118},{4,6,2,0.627451,0.917647,0.894118},{0,7,2,0.627451,0.917647,0.894118},{1,7,2,0.627451,0.917647,0.894118},{2,7,2,0.627451,0.917647,0.894118},{3,7,2,0.627451,0.917647,0.894118},{4,7,2,0.627451,0.917647,0.894118},{1,1,3,0.627451,0.917647,0.894118},{3,1,3,0.627451,0.917647,0.894118},{1,2,3,0.627451,0.917647,0.894118},{3,2,3,0.627451,0.917647,0.894118},{0,4,3,0.627451,0.917647,0.894118},{2,4,3,0.627451,0.917647,0.894118},{4,4,3,0.627451,0.917647,0.894118},{0,5,3,0.627451,0.917647,0.894118},{2,5,3,0.627451,0.917647,0.894118},{4,5,3,0.627451,0.917647,0.894118},{0,6,3,0.627451,0.917647,0.894118},{2,6,3,0.627451,0.917647,0.894118},{4,6,3,0.627451,0.917647,0.894118},{0,7,3,0.627451,0.917647,0.894118},{1,7,3,0.627451,0.917647,0.894118},{2,7,3,0.627451,0.917647,0.894118},{3,7,3,0.627451,0.917647,0.894118},{4,7,3,0.627451,0.917647,0.894118},{1,0,4,0.627451,0.917647,0.894118},{3,0,4,0.627451,0.917647,0.894118},{1,1,4,0.627451,0.917647,0.894118},{3,1,4,0.627451,0.917647,0.894118},{1,2,4,0.627451,0.917647,0.894118},{3,2,4,0.627451,0.917647,0.894118},{0,4,4,0.627451,0.917647,0.894118},{2,4,4,0.627451,0.917647,0.894118},{4,4,4,0.627451,0.917647,0.894118},{0,5,4,0.627451,0.917647,0.894118},{2,5,4,0.627451,0.917647,0.894118},{4,5,4,0.627451,0.917647,0.894118},{0,6,4,0.627451,0.917647,0.894118},{2,6,4,0.627451,0.917647,0.894118},{4,6,4,0.627451,0.917647,0.894118},{0,7,4,0.627451,0.917647,0.894118},{1,7,4,0.627451,0.917647,0.894118},{2,7,4,0.627451,0.917647,0.894118},{3,7,4,0.627451,0.917647,0.894118},{4,7,4,0.627451,0.917647,0.894118},{1,0,5,0.627451,0.917647,0.894118},{3,0,5,0.627451,0.917647,0.894118},{1,1,5,0.627451,0.917647,0.894118},{3,1,5,0.627451,0.917647,0.894118},{1,2,5,0.627451,0.917647,0.894118},{3,2,5,0.627451,0.917647,0.894118},{0,4,5,0.627451,0.917647,0.894118},{2,4,5,0.627451,0.917647,0.894118},{4,4,5,0.627451,0.917647,0.894118},{0,5,5,0.627451,0.917647,0.894118},{2,5,5,0.627451,0.917647,0.894118},{4,5,5,0.627451,0.917647,0.894118},{0,6,5,0.627451,0.917647,0.894118},{2,6,5,0.627451,0.917647,0.894118},{4,6,5,0.627451,0.917647,0.894118},{0,7,5,0.627451,0.917647,0.894118},{1,7,5,0.627451,0.917647,0.894118},{2,7,5,0.627451,0.917647,0.894118},{3,7,5,0.627451,0.917647,0.894118},{4,7,5,0.627451,0.917647,0.894118},{1,1,6,0.627451,0.917647,0.894118},{3,1,6,0.627451,0.917647,0.894118},{1,2,6,0.627451,0.917647,0.894118},{3,2,6,0.627451,0.917647,0.894118},{0,4,6,0.627451,0.917647,0.894118},{2,4,6,0.627451,0.917647,0.894118},{4,4,6,0.627451,0.917647,0.894118},{0,5,6,0.627451,0.917647,0.894118},{2,5,6,0.627451,0.917647,0.894118},{4,5,6,0.627451,0.917647,0.894118},{0,6,6,0.627451,0.917647,0.894118},{2,6,6,0.627451,0.917647,0.894118},{4,6,6,0.627451,0.917647,0.894118},{0,7,6,0.627451,0.917647,0.894118},{1,7,6,0.627451,0.917647,0.894118},{2,7,6,0.627451,0.917647,0.894118},{3,7,6,0.627451,0.917647,0.894118},{4,7,6,0.627451,0.917647,0.894118},{0,4,7,0.627451,0.917647,0.894118},{1,4,7,0.627451,0.917647,0.894118},{2,4,7,0.627451,0.917647,0.894118},{3,4,7,0.627451,0.917647,0.894118},{4,4,7,0.627451,0.917647,0.894118},{0,5,7,0.627451,0.917647,0.894118},{1,5,7,0.627451,0.917647,0.894118},{2,5,7,0.627451,0.917647,0.894118},{3,5,7,0.627451,0.917647,0.894118},{4,5,7,0.627451,0.917647,0.894118},{0,6,7,0.627451,0.917647,0.894118},{1,6,7,0.627451,0.917647,0.894118},{2,6,7,0.627451,0.917647,0.894118},{3,6,7,0.627451,0.917647,0.894118},{4,6,7,0.627451,0.917647,0.894118},{0,7,7,0.627451,0.917647,0.894118},{1,7,7,0.627451,0.917647,0.894118},{2,7,7,0.627451,0.917647,0.894118},{3,7,7,0.627451,0.917647,0.894118},{4,7,7,0.627451,0.917647,0.894118},{1,4,8,0.627451,0.917647,0.894118},{2,4,8,0.627451,0.917647,0.894118},{3,4,8,0.627451,0.917647,0.894118},{1,5,8,0.627451,0.917647,0.894118},{2,5,8,0.627451,0.917647,0.894118},{3,5,8,0.627451,0.917647,0.894118},{1,6,8,0.627451,0.917647,0.894118},{2,6,8,0.627451,0.917647,0.894118},{3,6,8,0.627451,0.917647,0.894118},{1,7,8,0.627451,0.917647,0.894118},{2,7,8,0.627451,0.917647,0.894118},{3,7,8,0.627451,0.917647,0.894118}};


    GLuint cubemap_texid[6];
    GLuint textureID[6];

const double M_TAU = M_PI * 2;

/*

	TODO: Fixa så man kan byta olika vyer och renderingslägen


*/

pthread_mutex_t joint_lock = PTHREAD_MUTEX_INITIALIZER;

struct vec2 {
	float x;
	float y;
};

struct vec3 {
	float x;
	float y;
	float z;
};

struct v3n3 {
	struct vec3 pos;
	struct vec3 normal;
};

struct v3n3u2 {
	struct vec3 pos;
	struct vec3 normal;
	struct vec2 uv;
};

struct quad {
	int vertex[4];
};

struct quad_uv {
	int vertex[4];
	struct vec2 uv[4];
};

struct vec3x3 {
	struct vec3 x;
	struct vec3 y;
	struct vec3 z;
};



#define randf() ((float)rand() / (float)RAND_MAX)
#define v1_random() (randf()*2.0-1.0)
#define v3_random() v3(v1_random(), v1_random(), v1_random())

#define v3(x, y, z) ((struct vec3) {x, y, z})
#define v3_v3_genlinop(ax, ay, az, bx, by, bz, op) v3(ax op bx, ay op by, az op bz)

#define v3_v3_add(a, b) v3_v3_genlinop(a.x, a.y, a.z, b.x, b.y, b.z, +)
#define s_v3_add(a, b) v3_v3_genlinop(a, a, a, b.x, b.y, b.z, +)
#define v3_s_add(a, b) v3_v3_genlinop(a.x, a.y, a.z, b, b, b, +)

#define v3_v3_sub(a, b) v3_v3_genlinop(a.x, a.y, a.z, b.x, b.y, b.z, -)
#define s_v3_sub(a, b) v3_v3_genlinop(a, a, a, b.x, b.y, b.z, -)
#define v3_s_sub(a, b) v3_v3_genlinop(a.x, a.y, a.z, b, b, b, -)

#define v3_s_mul(a, b) v3_v3_genlinop(a.x, a.y, a.z, b, b, b, *)
#define s_v3_mul(a, b) v3_v3_genlinop(a, a, a, b.x, b.y, b.z, *)

#define v3_s_div(a, b) v3_v3_genlinop(a.x, a.y, a.z, b, b, b, /)
#define s_v3_div(a, b) v3_v3_genlinop(a, a, a, b.x, b.y, b.z, /)

#define v3_inv(a) v3_v3_genlinop(0, 0, 0, a.x, a.y, a.z, -)

#define v3_v3_cross(a, b) v3(a.y * b.z - a.z * b.y, a.z * b.x - a.x * b.z, a.x * b.y - a.y * b.x)
#define v3_v3_dot(a, b) (a.x * b.x + a.y * b.y + a.z * b.z)
#define v3_abs(a) sqrt(v3_v3_dot(a, a))
#define v3_norm(a) v3_s_div(a, v3_abs(a))



#define COUNT(a) (sizeof(a)/sizeof(a[0]))


static void error_callback(int error, const char* description)
{
	fputs(description, stderr);
}






volatile struct vec3 cam = {0, -1.6, 0};
volatile struct vec3 cam_vel = {0, 0, 0};
volatile struct vec3 cam_rot = {0, 0, 0};
volatile struct vec3 cam_rot_vel = {0, 0, 0};


volatile struct vec3 cam_vel_v = {0, 0, 0};
volatile struct vec3 cam_rot_vel_v = {0, 0, 0};

const float vspeed = 500;
const float vrot = 20000;
float walking_forward = 0.0;
struct vec3 camera_vel = {0,0,0};

struct vec3 toaster_field_pos[500];
const int toasters=100;



struct vec3 ship_pos = {0,0,-200};
struct vec3 ship_dir = {1,0,0};
struct vec3 ship_vel = {0,0,0};

static void cursor_callback (GLFWwindow* window, double x, double y) {
	printf("Cursor: %f, %f\n", x, y);

}

volatile float thrust=0;

static void key_callback(GLFWwindow* window, int key, int scancode, int action, int mods)
{
	if (key == GLFW_KEY_ESCAPE && action == GLFW_PRESS)
		glfwSetWindowShouldClose(window, GL_TRUE);

	if (key == GLFW_KEY_A && action == GLFW_PRESS) {
		cam_vel_v.x = -vspeed;
	}
		
	if (key == GLFW_KEY_D && action == GLFW_PRESS) {
		cam_vel_v.x = vspeed;
	}

	if (key == GLFW_KEY_Z && action == GLFW_PRESS) {
		cam_vel_v.z = vspeed;
	}
		
	if (key == GLFW_KEY_X && action == GLFW_PRESS) {
		cam_vel_v.z = -vspeed;
	}

	if (key == GLFW_KEY_SPACE && action == GLFW_PRESS) {
		camera_vel.y -= 3;
	}


	if (key == GLFW_KEY_W && action == GLFW_PRESS) {
		thrust = 1.0;
	}
		
	if (key == GLFW_KEY_S && action == GLFW_PRESS) {
		thrust = -1.0;
	}

	if (key == GLFW_KEY_LEFT && action == GLFW_PRESS) {
		cam_rot_vel_v.y = vrot;
	}
		
	if (key == GLFW_KEY_RIGHT && action == GLFW_PRESS) {
		cam_rot_vel_v.y = -vrot;
	}

	if (key == GLFW_KEY_UP && action == GLFW_PRESS) {
		cam_rot_vel_v.x = vrot;
	}
		
	if (key == GLFW_KEY_DOWN && action == GLFW_PRESS) {
		cam_rot_vel_v.x = -vrot;
	}



	if (key == GLFW_KEY_A && action == GLFW_RELEASE) {
		cam_vel_v.x = 0;
	}
		
	if (key == GLFW_KEY_D && action == GLFW_RELEASE) {
		cam_vel_v.x = 0;
	}

	if (key == GLFW_KEY_Z && action == GLFW_RELEASE) {
		cam_vel_v.z = 0;
	}
		
	if (key == GLFW_KEY_X && action == GLFW_RELEASE) {
		cam_vel_v.z =  0;
	}

	if (key == GLFW_KEY_W && action == GLFW_RELEASE) {
		thrust = 0.0;
	}
		
	if (key == GLFW_KEY_S && action == GLFW_RELEASE) {
		thrust = 0.0;
	}

	if (key == GLFW_KEY_LEFT && action == GLFW_RELEASE) {
		cam_rot_vel_v.y = 0;
	}
		
	if (key == GLFW_KEY_RIGHT && action == GLFW_RELEASE) {
		cam_rot_vel_v.y = 0;
	}

	if (key == GLFW_KEY_UP && action == GLFW_RELEASE) {
		cam_rot_vel_v.x = 0;
	}
		
	if (key == GLFW_KEY_DOWN && action == GLFW_RELEASE) {
		cam_rot_vel_v.x = 0;
	}

}



//golv_marmor.jpg

float camera_matrix[16];


const float model_scale = 0.2;

struct vec3 projection_plane = {0.01, 0.025, 200.0};


#define invert_m16(inv, det, m)\
{\
    inv[0] = m[5]  * m[10] * m[15] - m[5]  * m[11] * m[14] - m[9]  * m[6]  * m[15] + m[9]  * m[7]  * m[14] +m[13] * m[6]  * m[11] - m[13] * m[7]  * m[10];\
    inv[4] = -m[4]  * m[10] * m[15] + m[4]  * m[11] * m[14] + m[8]  * m[6]  * m[15] - m[8]  * m[7]  * m[14] - m[12] * m[6]  * m[11] + m[12] * m[7]  * m[10];\
    inv[8] = m[4]  * m[9] * m[15] - m[4]  * m[11] * m[13] - m[8]  * m[5] * m[15] + m[8]  * m[7] * m[13] + m[12] * m[5] * m[11] - m[12] * m[7] * m[9];\
    inv[12] = -m[4]  * m[9] * m[14] + m[4]  * m[10] * m[13] +m[8]  * m[5] * m[14] - m[8]  * m[6] * m[13] - m[12] * m[5] * m[10] + m[12] * m[6] * m[9];\
    inv[1] = -m[1]  * m[10] * m[15] + m[1]  * m[11] * m[14] + m[9]  * m[2] * m[15] - m[9]  * m[3] * m[14] - m[13] * m[2] * m[11] + m[13] * m[3] * m[10];\
    inv[5] = m[0]  * m[10] * m[15] - m[0]  * m[11] * m[14] - m[8]  * m[2] * m[15] + m[8]  * m[3] * m[14] + m[12] * m[2] * m[11] - m[12] * m[3] * m[10];\
    inv[9] = -m[0]  * m[9] * m[15] + m[0]  * m[11] * m[13] + m[8]  * m[1] * m[15] - m[8]  * m[3] * m[13] - m[12] * m[1] * m[11] + m[12] * m[3] * m[9];\
    inv[13] = m[0]  * m[9] * m[14] - m[0]  * m[10] * m[13] - m[8]  * m[1] * m[14] + m[8]  * m[2] * m[13] + m[12] * m[1] * m[10] - m[12] * m[2] * m[9];\
    inv[2] = m[1]  * m[6] * m[15] - m[1]  * m[7] * m[14] - m[5]  * m[2] * m[15] + m[5]  * m[3] * m[14] + m[13] * m[2] * m[7] - m[13] * m[3] * m[6];\
    inv[6] = -m[0]  * m[6] * m[15] + m[0]  * m[7] * m[14] + m[4]  * m[2] * m[15] - m[4]  * m[3] * m[14] - m[12] * m[2] * m[7] + m[12] * m[3] * m[6];\
    inv[10] = m[0]  * m[5] * m[15] - m[0]  * m[7] * m[13] - m[4]  * m[1] * m[15] + m[4]  * m[3] * m[13] + m[12] * m[1] * m[7] - m[12] * m[3] * m[5];\
    inv[14] = -m[0]  * m[5] * m[14] + m[0]  * m[6] * m[13] + m[4]  * m[1] * m[14] - m[4]  * m[2] * m[13] - m[12] * m[1] * m[6] + m[12] * m[2] * m[5];\
    inv[3] = -m[1] * m[6] * m[11] + m[1] * m[7] * m[10] + m[5] * m[2] * m[11] - m[5] * m[3] * m[10] - m[9] * m[2] * m[7] + m[9] * m[3] * m[6];\
    inv[7] = m[0] * m[6] * m[11] - m[0] * m[7] * m[10] - m[4] * m[2] * m[11] + m[4] * m[3] * m[10] + m[8] * m[2] * m[7] - m[8] * m[3] * m[6];\
    inv[11] = -m[0] * m[5] * m[11] + m[0] * m[7] * m[9] + m[4] * m[1] * m[11] - m[4] * m[3] * m[9] - m[8] * m[1] * m[7] + m[8] * m[3] * m[5];\
    inv[15] = m[0] * m[5] * m[10] - m[0] * m[6] * m[9] - m[4] * m[1] * m[10] + m[4] * m[2] * m[9] + m[8] * m[1] * m[6] - m[8] * m[2] * m[5];\
\
    det = m[0] * inv[0] + m[1] * inv[4] + m[2] * inv[8] + m[3] * inv[12];\
\
    if (det) {    \
      inv[0] /= det; inv[1] /= det; inv[2] /= det; inv[3] /= det; inv[4] /= det; inv[5] /= det; inv[6] /= det; inv[7] /= det; \
      inv[8] /= det; inv[9] /= det; inv[10] /= det; inv[11] /= det; inv[12] /= det; inv[13] /= det; inv[14] /= det; inv[15] /= det;\
    }\
    \
}




/*
 0  1  2  3 
 4  5  6  7
 8  9  10 11
 12 13 14 15

 0  4  8  12
 1  5  9  13 
 2  6  10 14
 3  7  11 15

 */

//#define m16_v3_mul(a, b) v3(a[0]*b.x + a[1]*b.y + a[2]*b.z + a[3], a[4]*b.x + a[5]*b.y + a[6]*b.z + a[7], a[8]*b.x + a[9]*b.y + a[10]*b.z + a[11])
#define m16_v3_mul(a, b) v3(a[0]*b.x + a[4]*b.y + a[8]*b.z + a[12], a[1]*b.x + a[5]*b.y + a[9]*b.z + a[13], a[2]*b.x + a[6]*b.y + a[10]*b.z + a[14])
#define m16_v3_mul_dir(a, b) v3(a[0]*b.x + a[4]*b.y + a[8]*b.z, a[1]*b.x + a[5]*b.y + a[9]*b.z, a[2]*b.x + a[6]*b.y + a[10]*b.z)

#define f_vec3(f, v) {struct vec3 t = v; f(t.x, t.y, t.z);}
#define line_vec3(a, b) {f_vec3(glVertex3f, a); f_vec3(glVertex3f, b); }





int init() {
	glfwSetErrorCallback(error_callback);
	return glfwInit();

}



void draw_starfield(float ct) {


	float s = fmod(ct*.01, 1.0);
	float t = sin(ct*.1)*.1;
	float tw = 5;
	float sw = 5;


	float size=100;
	glColor3f(1,1,1);

	glActiveTexture(GL_TEXTURE1);
	glEnable(GL_TEXTURE_2D);
	glBindTexture(GL_TEXTURE_2D, textureID[1]);
	glActiveTexture(GL_TEXTURE0);

	
	glBindTexture(GL_TEXTURE_2D, cubemap_texid[4]);
	glBegin(GL_QUADS);
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(0, 0, -1); glVertex3f(-size, -size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(1, 0); glNormal3f(0, 0, -1); glVertex3f(size, -size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(0, 0, -1); glVertex3f(size, size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(0, 1); glNormal3f(0, 0, -1); glVertex3f(-size, size, size);
	glEnd();

	glBindTexture(GL_TEXTURE_2D, cubemap_texid[5]);
	glBegin(GL_QUADS);
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(0, 0, 1); glVertex3f(-size, -size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(0, 1); glNormal3f(0, 0, 1); glVertex3f(-size, size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(0, 0, 1); glVertex3f(size, size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(1, 0); glNormal3f(0, 0, 1); glVertex3f(size, -size, -size);
	glEnd();

	glBindTexture(GL_TEXTURE_2D, cubemap_texid[3]);
	glBegin(GL_QUADS);
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(0, 1, 0); glVertex3f(-size, -size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(1, 0); glNormal3f(0, 1, 0); glVertex3f(size, -size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(0, 1, 0); glVertex3f(size, -size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(0, 1); glNormal3f(0, 1, 0); glVertex3f(-size, -size, size);
	glEnd();
		
	glBindTexture(GL_TEXTURE_2D, cubemap_texid[2]);
	glBegin(GL_QUADS);
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(0, -1, 0); glVertex3f(-size, size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(0, 1); glNormal3f(0, -1, 0); glVertex3f(-size, size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(0, -1, 0); glVertex3f(size, size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(1, 0); glNormal3f(0, -1, 0); glVertex3f(size, size, -size);
	glEnd();

	glBindTexture(GL_TEXTURE_2D, cubemap_texid[0]);
	glBegin(GL_QUADS);
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(-1, 0, 0); glVertex3f(size, -size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(1, 0); glNormal3f(-1, 0, 0); glVertex3f(size, size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(-1, 0, 0); glVertex3f(size, size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(0, 1); glNormal3f(-1, 0, 0); glVertex3f(size, -size, size);
	glEnd();
		

	glBindTexture(GL_TEXTURE_2D, cubemap_texid[1]);
	glBegin(GL_QUADS);	
	glMultiTexCoord2f(GL_TEXTURE1, s, t); glTexCoord2f(0, 0); glNormal3f(1, 0, 0); glVertex3f(-size, -size, -size);
	glMultiTexCoord2f(GL_TEXTURE1, s, t+tw); glTexCoord2f(0, 1); glNormal3f(1, 0, 0); glVertex3f(-size, -size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t+tw); glTexCoord2f(1, 1); glNormal3f(1, 0, 0); glVertex3f(-size, size, size);
	glMultiTexCoord2f(GL_TEXTURE1, s+sw, t); glTexCoord2f(1, 0); glNormal3f(1, 0, 0); glVertex3f(-size, size, -size);
	glEnd();


	glActiveTexture(GL_TEXTURE1);
	glDisable(GL_TEXTURE_2D);
	glActiveTexture(GL_TEXTURE0);

}


void draw_cube(struct cube* cube) {


	glBegin(GL_QUADS);
	glColor3f(cube->r, cube->g, cube->b);



	glTexCoord2f(0, 0); glNormal3f(0, 0, 1); glVertex3f(cube->x, cube->y, cube->z+1);
	glTexCoord2f(1, 0); glNormal3f(0, 0, 1); glVertex3f(cube->x+1, cube->y, cube->z+1);
	glTexCoord2f(1, 1); glNormal3f(0, 0, 1); glVertex3f(cube->x+1, cube->y+1, cube->z+1);
	glTexCoord2f(0, 1); glNormal3f(0, 0, 1); glVertex3f(cube->x, cube->y+1, cube->z+1);

	glTexCoord2f(0, 0); glNormal3f(0, 0, -1); glVertex3f(cube->x, cube->y, cube->z);
	glTexCoord2f(0, 1); glNormal3f(0, 0, -1); glVertex3f(cube->x, cube->y+1, cube->z);
	glTexCoord2f(1, 1); glNormal3f(0, 0, -1); glVertex3f(cube->x+1, cube->y+1, cube->z);
	glTexCoord2f(1, 0); glNormal3f(0, 0, -1); glVertex3f(cube->x+1, cube->y, cube->z);

	glTexCoord2f(0, 0); glNormal3f(0, -1, 0); glVertex3f(cube->x, cube->y, cube->z);
	glTexCoord2f(1, 0); glNormal3f(0, -1, 0); glVertex3f(cube->x+1, cube->y, cube->z);
	glTexCoord2f(1, 1); glNormal3f(0, -1, 0); glVertex3f(cube->x+1, cube->y, cube->z+1);
	glTexCoord2f(0, 1); glNormal3f(0, -1, 0); glVertex3f(cube->x, cube->y, cube->z+1);
		
	glTexCoord2f(0, 0); glNormal3f(0, 1, 0); glVertex3f(cube->x, cube->y+1, cube->z);
	glTexCoord2f(0, 1); glNormal3f(0, 1, 0); glVertex3f(cube->x, cube->y+1, cube->z+1);
	glTexCoord2f(1, 1); glNormal3f(0, 1, 0); glVertex3f(cube->x+1, cube->y+1, cube->z+1);
	glTexCoord2f(1, 0); glNormal3f(0, 1, 0); glVertex3f(cube->x+1, cube->y+1, cube->z);

	glTexCoord2f(0, 0); glNormal3f(1, 0, 0); glVertex3f(cube->x+1, cube->y, cube->z);
	glTexCoord2f(1, 0); glNormal3f(1, 0, 0); glVertex3f(cube->x+1, cube->y+1, cube->z);
	glTexCoord2f(1, 1); glNormal3f(1, 0, 0); glVertex3f(cube->x+1, cube->y+1, cube->z+1);
	glTexCoord2f(0, 1); glNormal3f(1, 0, 0); glVertex3f(cube->x+1, cube->y, cube->z+1);
		
	glTexCoord2f(0, 0); glNormal3f(-1, 0, 0); glVertex3f(cube->x, cube->y, cube->z);
	glTexCoord2f(0, 1); glNormal3f(-1, 0, 0); glVertex3f(cube->x, cube->y, cube->z+1);
	glTexCoord2f(1, 1); glNormal3f(-1, 0, 0); glVertex3f(cube->x, cube->y+1, cube->z+1);
	glTexCoord2f(1, 0); glNormal3f(-1, 0, 0); glVertex3f(cube->x, cube->y+1, cube->z);


	glEnd();

}



int main()
{

	for (int t=0; t<toasters; t++) {
		toaster_field_pos[t] = v3_s_mul(v3_random(), 500);
	}

	GLFWwindow* window;
	init();

	window = glfwCreateWindow(640, 480, "Simple example", NULL, NULL);


	if (!window)
	{
		glfwTerminate();
		return 0;
	}

	glfwMakeContextCurrent(window);

	//glfwSetInputMode(window, GLFW_CURSOR, GLFW_CURSOR_DISABLED);

	glfwSetKeyCallback(window, key_callback);
	//glfwSetCursorPosCallback(window, cursor_callback);

	glEnable(GL_CULL_FACE);
	glEnable(GL_LIGHT0);
	glEnable(GL_DEPTH_TEST);
	glEnable(GL_BLEND);
	glTexEnvi(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);

	//glBlendEquationSeparate(GL_FUNC_MULTIPLY, GL_FUNC_MULTIPLY);
	//glBlendFuncSeparate(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA, GL_ONE, GL_ZERO);
//	glEnable(GL_NORMALIZE);  
	//glEnable(GL_NORMALIZE);
//    glEnable(GL_TEXTURE_2D);

	GLfloat mat_specular[] = { 1.0, 1.0, 1.0, 1.0 }; 
	GLfloat mat_ambient[] = { 0.4, 0.6, 1.0, 1.0 }; 
	GLfloat mat_shininess[] = { 50.0 };
	GLfloat light_position[] = { -1.0, 1.0, 1.0, 0.0 };


	glColorMaterial(GL_FRONT, GL_DIFFUSE);

	glEnable(GL_COLOR_MATERIAL);

	// glPolygonMode( GL_FRONT, GL_LINE );
	// glPolygonMode( GL_BACK, GL_POINT );


	double ot, nt = glfwGetTime();


    //glGenTextures(6, &cubemap_texid);


	char filename[256];
	for (int s = 0; s<6; s++) {

		snprintf(filename, 256, "textures/output_%i.png", s);

		printf("\t%s\n", filename);

	    cubemap_texid[s] = SOIL_load_OGL_texture(filename, SOIL_LOAD_RGBA, SOIL_CREATE_NEW_ID, SOIL_FLAG_INVERT_Y);
	    printf ("Texture id: %i\n", cubemap_texid[s]);
	    glBindTexture(GL_TEXTURE_2D, cubemap_texid[s]);
	    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
	    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);

	}




    //glGenTextures(1, &textureID);

    textureID[0] = SOIL_load_OGL_texture("textures/spaceshipwall.png", SOIL_LOAD_RGBA, SOIL_CREATE_NEW_ID, SOIL_FLAG_INVERT_Y);
	printf ("Texture id: %i\n", textureID[0]);

    // textureID[1] = SOIL_load_OGL_texture("/srv/texturer/brains.jpg", SOIL_LOAD_RGBA, SOIL_CREATE_NEW_ID, SOIL_FLAG_INVERT_Y);
    
    // "Bind" the newly created texture : all future texture functions will modify this texture
     
    // Give the image to OpenGL
    //glTexImage2D(GL_TEXTURE_2D, 0,GL_RGB, twidth, theight, 0, GL_BGR, GL_UNSIGNED_BYTE, tdata);

    glBindTexture(GL_TEXTURE_2D, textureID[0]);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);

	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);


    textureID[1] = SOIL_load_OGL_texture("textures/disco.png", SOIL_LOAD_RGBA, SOIL_CREATE_NEW_ID, SOIL_FLAG_INVERT_Y);
	printf ("Texture id: %i\n", textureID[1]);

    // textureID[1] = SOIL_load_OGL_texture("/srv/texturer/brains.jpg", SOIL_LOAD_RGBA, SOIL_CREATE_NEW_ID, SOIL_FLAG_INVERT_Y);
    
    // "Bind" the newly created texture : all future texture functions will modify this texture
     
    // Give the image to OpenGL
    //glTexImage2D(GL_TEXTURE_2D, 0,GL_RGB, twidth, theight, 0, GL_BGR, GL_UNSIGNED_BYTE, tdata);

    glBindTexture(GL_TEXTURE_2D, textureID[1]);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);

	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);


 //    glBindTexture(GL_TEXTURE_2D, textureID[1]);
 //    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
 //    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);

	// glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
	// glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);


	
	// glfwSetCursorPos(window, 0, 0);




	while (!glfwWindowShouldClose(window)) {


		ot=nt;
		nt =glfwGetTime();
		float dt = nt - ot;

		



		double cx, cy;
		// glfwGetCursorPos(window, &cx, &cy);
		// glfwSetCursorPos(window, 0, 0);


		float ratio;
		int width, height;
		glfwGetFramebufferSize(window, &width, &height);
		ratio = width / (float) height;
		glViewport(0, 0, width, height);



		glMatrixMode(GL_PROJECTION);
		glLoadIdentity();

		glFrustum(-ratio*projection_plane.x, ratio*projection_plane.x, -projection_plane.x, projection_plane.x, projection_plane.y, projection_plane.z);
		const float scale = 0.2;
		glScalef(scale, scale, scale);


		glMaterialfv(GL_FRONT, GL_SPECULAR, mat_specular);
		glMaterialfv(GL_FRONT, GL_SHININESS, mat_shininess);
		glMaterialfv(GL_FRONT, GL_AMBIENT, mat_ambient);

		// struct vec3 camera_z = v3_norm(v3_v3_sub(camera_pos, v3(0, 0, 0)));
		// struct vec3 camera_x = v3_norm(v3_v3_cross(v3(0, 1, 0), camera_z));
		// struct vec3 camera_y = v3_v3_cross(camera_x, camera_z);


		ship_pos = v3_v3_add(ship_pos, v3_s_mul(ship_vel, dt));
		ship_vel = v3_v3_add(ship_vel, v3_s_mul(ship_dir, dt * thrust));

		//Camera is ship

		ship_dir.x = cos(nt*.03)*cos(nt*.01);
		ship_dir.y = sin(nt*.03)*cos(nt*.01);
		ship_dir.z = sin(nt*.01);

		struct vec3 camera_pos = ship_pos;
		struct vec3 camera_z = ship_dir;
		struct vec3 camera_x = v3_norm(v3_v3_cross(v3(0, 1, 0), camera_z));
		struct vec3 camera_y = v3_v3_cross(camera_x, camera_z);


		float camera_m[16] = {
			camera_x.x, camera_y.x, camera_z.x, 0,
			camera_x.y, camera_y.y, camera_z.y, 0,
			camera_x.z, camera_y.z, camera_z.z, 0,
			v3_v3_dot(camera_x, camera_pos), v3_v3_dot(camera_y, camera_pos), v3_v3_dot(camera_z, camera_pos), 1,
		};



		glClear(GL_COLOR_BUFFER_BIT);
		glDisable(GL_DEPTH_TEST);
		glDisable(GL_LIGHTING);

		//Draw starfield
		glMatrixMode(GL_MODELVIEW);
	    glEnable(GL_TEXTURE_2D);
		glLoadMatrixf(camera_m);
		f_vec3(glTranslatef, v3_inv(ship_pos));
		glCullFace(GL_BACK);

		draw_starfield(nt);
		glCullFace(GL_FRONT);	

		glEnable(GL_DEPTH_TEST);
		glClear(GL_DEPTH_BUFFER_BIT);


		glMatrixMode(GL_MODELVIEW);
		glLoadIdentity();

		glLightfv(GL_LIGHT0, GL_POSITION, light_position);




	    glBindTexture(GL_TEXTURE_2D, 0);




		//f_vec3(glTranslatef, camera_pos);

    	glBindTexture(GL_TEXTURE_2D, textureID[0]);
	    glEnable(GL_TEXTURE_2D);
	    glEnable(GL_LIGHTING);
	    glColor3f(1, 1, 1);



		glMatrixMode(GL_MODELVIEW);
		glLoadMatrixf(camera_m);

		glLightfv(GL_LIGHT0, GL_POSITION, light_position);

		glPushMatrix();

			glLoadIdentity();
			glTranslatef(-10, -15, -100);
			glMultMatrixf(camera_m);
			f_vec3(glTranslatef, v3_inv(ship_pos));

			for (int c=0; c<558; c++) {
				draw_cube(&ship[c]);
			}


		glPopMatrix();


		for (int ts=0; ts<toasters; ts++) {

			// toaster_field_pos[ts] = v3_v3_add(toaster_field_pos[ts], v3(0,0,50*dt));
			// if (toaster_field_pos[ts].z > 500) {
			// 	toaster_field_pos[ts].z = -500;
			// }

			toaster_field_pos[ts] = v3_v3_add(toaster_field_pos[ts], v3((30+20*ts/toasters)*-dt ,sin(nt*(2+5*ts/toasters))*dt*30,0));
			if (toaster_field_pos[ts].x <-1500) {
				toaster_field_pos[ts].x = 1500;
			}


			glPushMatrix();

				glLoadIdentity();
				f_vec3(glTranslatef, toaster_field_pos[ts]);
				glMultMatrixf(camera_m);
				glTranslatef(-3, -5, -5);


				for (int c=0; c<141; c++) {
					draw_cube(&toaster[c]);
				}

			glPopMatrix();

		}

    		

		// glDisable(GL_DEPTH_TEST);





		glfwSwapBuffers(window);
		glfwPollEvents();
	}
	

	glfwDestroyWindow(window);
	
	glfwTerminate();
	return(EXIT_SUCCESS);
}


